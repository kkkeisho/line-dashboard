// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== ユーザー（社内ユーザー） ==========
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String
  role          Role     @default(AGENT)
  passwordHash  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  assignedConversations Conversation[]
  auditLogs             AuditLog[]

  @@index([email])
  @@index([role])
}

enum Role {
  ADMIN
  AGENT
  VIEWER
}

// ========== コンタクト（LINEユーザー） ==========
model Contact {
  id          String    @id @default(cuid())
  lineUserId  String    @unique
  displayName String
  pictureUrl  String?
  followedAt  DateTime
  isBlocked   Boolean   @default(false)
  memo        String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  conversations     Conversation[]
  conversationTags  ConversationTag[]

  @@index([lineUserId])
  @@index([displayName])
}

// ========== 会話（Conversationスレッド） ==========
model Conversation {
  id                   String         @id @default(cuid())
  contactId            String
  status               Status         @default(NEW)
  assignedUserId       String?
  priority             Priority       @default(MEDIUM)
  urgency              Urgency        @default(ANYTIME)
  isComplaint          Boolean        @default(false)
  complaintType        ComplaintType?
  lastInboundAt        DateTime?
  lastOutboundAt       DateTime?
  lastMessagePreview   String?
  slaDeadline          DateTime?
  version              Int            @default(0)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  contact       Contact            @relation(fields: [contactId], references: [id])
  assignedUser  User?              @relation(fields: [assignedUserId], references: [id])
  messages      Message[]
  tags          ConversationTag[]
  auditLogs     AuditLog[]

  @@index([contactId])
  @@index([status])
  @@index([assignedUserId])
  @@index([lastInboundAt])
  @@index([priority, urgency])
}

enum Status {
  NEW
  WORKING
  PENDING
  RESOLVED
  CLOSED
  NO_ACTION_NEEDED
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}

enum Urgency {
  NOW
  TODAY
  THIS_WEEK
  ANYTIME
}

enum ComplaintType {
  BILLING
  QUALITY
  DELAY
  ATTITUDE
  OTHER
}

// ========== メッセージ ==========
model Message {
  id              String    @id @default(cuid())
  conversationId  String
  direction       Direction
  text            String?
  lineMessageId   String?   @unique
  timestamp       DateTime
  rawPayload      Json?
  createdAt       DateTime  @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id])

  @@index([conversationId])
  @@index([timestamp])
  @@index([direction])
}

enum Direction {
  INBOUND
  OUTBOUND
}

// ========== タグマスタ ==========
model Tag {
  id          String   @id @default(cuid())
  name        String   @unique
  color       String?
  createdAt   DateTime @default(now())

  conversationTags ConversationTag[]
}

// ========== 会話×タグの中間テーブル ==========
model ConversationTag {
  id             String   @id @default(cuid())
  conversationId String
  contactId      String
  tagId          String
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id])
  contact      Contact      @relation(fields: [contactId], references: [id])
  tag          Tag          @relation(fields: [tagId], references: [id])

  @@unique([conversationId, tagId])
  @@index([conversationId])
  @@index([tagId])
}

// ========== 監査ログ ==========
model AuditLog {
  id             String   @id @default(cuid())
  conversationId String?
  userId         String
  action         String
  changes        Json?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())

  conversation Conversation? @relation(fields: [conversationId], references: [id])
  user         User          @relation(fields: [userId], references: [id])

  @@index([conversationId])
  @@index([userId])
  @@index([createdAt])
}
